<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Details - <span id='character-name'></span></title>

    <!-- HTML Meta Tags -->
    <meta name="description" content="Details about <span id='character-name'></span>: <span id='character-description'></span>">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Character Details - <span id='character-name'></span>">
    <meta property="og:description" content="Details about <span id='character-name'></span>: <span id='character-description'></span>">
    <meta property="og:image" content="">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="efroai.net">
    <meta property="twitter:url" content="">
    <meta name="twitter:title" content="Character Details - <span id='character-name'></span>">
    <meta name="twitter:description" content="Details about <span id='character-name'></span>: <span id='character-description'></span>">
    <meta name="twitter:image" content="">

    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div id="character-details-container">
        <h1 id="character-name"></h1>
        <img id="character-image" alt="Character Image">
        <p id="character-description"></p>
        <p id="character-tags"></p>
        <p id="character-creator"></p>
        <button id="chat-button" style="display: none;">Chat</button>
    </div>
    <script>
        const backendurl = 'https://characters.efroai.net:3000';

        // Function to parse URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                uploader: params.get('uploader'),
                characterId: params.get('characterId')
            };
        }

        // Function to load character details
        function loadCharacterDetails() {
            const { characterId, uploader } = getUrlParams();
            fetch(`${backendurl}/api/chat/${uploader}/${characterId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 403) {
                        throw new Error('Character is not approved.');
                    } else if (response.status === 404) {
                        throw new Error('Character or user not found.');
                    } else {
                        throw new Error('An error occurred while fetching character details.');
                    }
                })
                .then(character => displayCharacterDetails(character))
                .catch(error => {
                    console.error('Error fetching character details:', error);
                    document.getElementById('character-details-container').innerHTML = `<p>${error.message}</p>`;
                });
        }

        // Function to display character details on the page
        function displayCharacterDetails(character) {
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-description').textContent = character.chardescription || 'No description available.';
            document.getElementById('character-creator').textContent = `Created by: ${character.uploader || 'Unknown'}`;

            // Display tags
            const tagsElement = document.getElementById('character-tags');
            tagsElement.innerHTML = (character.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ');

            // Set the character image URL directly
            const imgElement = document.getElementById('character-image');
            const imageUrl = `${backendurl}/api/characters/${character.uploader}/images/${character.id}`;

            // Set the image source
            imgElement.src = imageUrl;

            // Update meta tags with the new character data for social sharing
            updateMetaTags(character, imageUrl);

            // Display the "Chat" button
            const chatButton = document.getElementById('chat-button');
            chatButton.style.display = 'inline-block';
            chatButton.onclick = () => openCharacterPage(character.id, character.uploader);
        }

        // Function to update meta tags for social sharing
        function updateMetaTags(character, imageUrl) {
            document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.href);
            document.querySelector('meta[property="og:title"]').setAttribute('content', `Character Details - ${character.name}`);
            document.querySelector('meta[property="og:description"]').setAttribute('content', character.chardescription || 'No description available.');
            document.querySelector('meta[property="og:image"]').setAttribute('content', imageUrl);

            document.querySelector('meta[name="twitter:url"]').setAttribute('content', window.location.href);
            document.querySelector('meta[name="twitter:title"]').setAttribute('content', `Character Details - ${character.name}`);
            document.querySelector('meta[name="twitter:description"]').setAttribute('content', character.chardescription || 'No description available.');
            document.querySelector('meta[name="twitter:image"]').setAttribute('content', imageUrl);
        }

        // Function to navigate to the chat page
        function openCharacterPage(characterId, uploader) {
            window.location.href = `/chat.html?uploader=${encodeURIComponent(uploader)}&characterId=${encodeURIComponent(characterId)}`;
        }

        // Load character details on page load
        document.addEventListener('DOMContentLoaded', loadCharacterDetails);
    </script>
</body>
</html>
