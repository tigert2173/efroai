<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Character Details</title>
    <!-- <link rel="stylesheet" href="/css/styles.css"> --> 

    <style>
        body {
            background-color: #1c1c1c; /* Dark background for contrast */
            color: #eaeaea; /* Light text for readability */
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }

        #character-details-container {
            max-width: 600px;
            margin: auto;
            background: rgb(12, 36, 10);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            overflow: hidden; /* Prevent overflow */
        }

        .eas6a97888e38 {
            max-width: 100%; /* Ensure the ad does not exceed the width of the container */
            height: auto; /* Maintain aspect ratio */
        }

        #character-details-container:hover {
            transform: translateY(-5px); /* Subtle lift on hover */
        }

        h1 {
            font-size: 28px; /* Increased font size */
            margin-bottom: 15px;
            color: #00ff66;
        }

        #character-image {
            width: auto;
            max-height: 500px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 3px solid #00ff66; /* Bright border for images */

        }

        #character-description {
            font-size: 18px; /* Increased font size */
            margin: 15px 0;
            color: #dedede;
        }
       
        #character-creator {
            font-size: 20px; /* Increased font size for the creator's name */
            color: #ffcc00; /* Yellow color for emphasis */
            margin-bottom: 25px; /* Increased margin for spacing */
            font-weight: bold; /* Bold text for emphasis */
        }

        #character-tags {
            font-size: 16px; /* Increased font size for tags */
            margin-bottom: 20px;
        }

        .tag {
            display: inline-block;
            background-color: #333;
            color: #00ff66;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 2px 3px;
        }

        #chat-button {
            background-color: #00ff66;
            color: #1b1b1b;
            padding: 15px 25px; /* Increased padding */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            font-size: 18px; /* Increased font size */
        }

        #chat-button:hover {
            background-color: #00e55d; /* Darker shade on hover */
            transform: translateY(-2px);
        }

        #chat-button:focus {
            outline: none; /* Remove focus outline */
        }

        /* Mobile Styles */
        @media (max-width: 600px) {
            #character-details-container {
                padding: 20px; /* Less padding on mobile */
            }

            h1 {
                font-size: 24px; /* Adjust heading size on mobile */
            }

            #character-description,
            #character-creator,
            #chat-button {
                font-size: 16px; /* Consistent font size on mobile */
            }
        }
        .ad-container {
        display: flex;
        justify-content: center;
        margin-bottom: 15px;
        margin-top: -15px; /* Adjust margin as needed */
        transform-origin: center; /* Center the scaling effect */
    }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="navbar">
            <div class="left-content">
                <a href="/" class="logo"> <!-- Make the logo clickable -->
                <div class="logo">
                    <img src="logo.png" alt=" ">
                </div>
            </a>
            <a href="/" class="text">
                <div class="text">
                    <span class="letter letter-1">E</span>
                    <span class="letter letter-2">F</span>
                    <span class="letter letter-3">R</span>
                    <span class="letter letter-4">O</span>
                    <span class="letter letter-5">.</span>
                    <span class="letter letter-6">A</span>
                    <span class="letter letter-7">I</span>
                </div>
            </a>
            </div>
    <div class="right-content">
        <ul class="nav-links">
            <!-- Characters with dropdown -->
            <li class="dropdown">
                <a href="index.html" class="dropbtn" onclick="toggleDropdown(event)">Characters</a>
                <div class="dropdown-content">
                    <a href="index.html">Characters Hub</a>
                    <a href="editor.html">Upload Character</a>
                    <a href="mycharacters.html">My Characters</a>
                </div>
            </li>

            <!-- Community with dropdown -->
            <li class="dropdown">
                <a href="rules.html" class="dropbtn" onclick="toggleDropdown(event)">Community</a>
                <div class="dropdown-content">
                    <a href="rules.html">Rules</a>
                    <a href="join-our-team.html">Get Involved in the Fetish Scene</a>
                    <a href="/EFROTales/">Old Stories Page</a>
                </div>
            </li>

            <!-- Account with dropdown -->
            <li class="dropdown">
                <a href="myaccount.html" class="dropbtn" onclick="toggleDropdown(event)">Account</a>
                <div class="dropdown-content">
                    <a href="myaccount.html">Account</a>
                    <a href="mylikes.html">My Likes</a>
                    <a href="login.html">Login</a>
                    <a href="subscriptions.html" class="nav-btn">Subscriptions</a>
                </div>
            </li>

            <!-- Help with dropdown -->
            <li class="dropdown">
                <a href="contact.html" class="dropbtn" onclick="toggleDropdown(event)">Help</a>
                <div class="dropdown-content">
                    <a href="documentation.html">Documentation</a>
                    <a href="updates.html">Updates & Features</a>
                    <a href="contact.html">Contact</a>
                </div>
            </li>

            <!-- Contribute Button -->
            <li>
                <a href="contribute.html" class="nav-btn">Contribute</a>
            </li>
            
        </ul>     

        <!-- Search bar -->
        <!-- <input type="text" id="search-bar" placeholder="Search characters..." class="search-bar"> -->
        <div id="login-status" class="login-status"></div>

        <!-- Hamburger menu for mobile view -->
        <div class="hamburger" onclick="toggleMenu()">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>  
    </div>
</nav>
    </header>
    <link rel="stylesheet" href="css/menu2.0.css">
    <script src="js/menu.js"></script>

        <script>
            // Function to decode JWT and check for the Ad-Exempt claim
            function isAdExempt(token) {
                if (!token) return false; // If there's no token, assume not exempt
            
                // Decode the JWT (assuming it's a standard JWT with 3 parts)
                const payload = token.split('.')[1]; // Get the payload part
                const decodedPayload = JSON.parse(atob(payload)); // Decode base64 URL and parse as JSON
            
                return decodedPayload['AdExempt'] === true; // Check the Ad-Exempt claim
            }
            
            let adExempt = false; // Check if the user is Ad-Exempt
            const userToken = localStorage.getItem('token'); // Replace with your method of obtaining the token
            
            adExempt = isAdExempt(userToken);
        </script>
    <div id="character-details-container">
        <h1 id="character-name"></h1>
        <img id="character-image" alt="Character Image">
        <p id="character-description"></p>
        <p id="character-tags"></p>
        <p id="character-creator"></p>
    
        <button id="chat-button" style="display: none;">Chat</button>
    </div>
    
    <script>
        const backendurl = 'https://characters.efroai.net';

        // Function to parse URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                uploader: params.get('uploader'),
                characterId: params.get('characterId')
            };
        }

        // Function to load character details
        function loadCharacterDetails() {
            const { characterId, uploader } = getUrlParams();
            fetch(`${backendurl}/api/chat/${uploader}/${characterId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 403) {
                        throw new Error('Character is not approved.');
                    } else if (response.status === 404) {
                        throw new Error('Character or user not found.');
                    } else {
                        throw new Error('An error occurred while fetching character details.');
                    }
                })
                .then(character => displayCharacterDetails(character))
                .catch(error => {
                    console.error('Error fetching character details:', error);
                    document.getElementById('character-details-container').innerHTML = `<p>${error.message}</p>`;
                });
        }

        // Function to display character details on the page
        function displayCharacterDetails(character) {
            document.getElementById('character-name').textContent = character.name;
            document.getElementById('character-description').textContent = character.chardescription || 'No description available.';
            document.getElementById('character-creator').textContent = `Created by: ${character.uploader || 'Unknown'}`;

            // Display tags
            const tagsElement = document.getElementById('character-tags');
            tagsElement.innerHTML = (character.tags || []).map(tag => `<span class="tag">${tag}</span>`).join(' ');

            // Display character image with fetch and error handling
            const imgElement = document.getElementById('character-image');
            const imageUrl = `${backendurl}/api/characters/${character.uploader}/images/${character.id}`;

            fetch(imageUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'image/avif,image/webp,image/png,image/svg+xml,image/jpeg,image/*;q=0.8,*/*;q=0.5'
                }
            })
            .then(response => {
                if (!response.ok) {
                    console.error(`Failed to fetch image: ${response.statusText}`);
                    imgElement.src = 'noimage.jpg'; // Fallback to default image
                    return;
                }
                return response.blob();
            })
            .then(imageBlob => {
                if (imageBlob) {
                    const imageObjectURL = URL.createObjectURL(imageBlob);
                    imgElement.src = imageObjectURL;
                }
            })
            .catch(error => {
                console.error('Error fetching image:', error);
                imgElement.src = 'noimage.jpg'; // Fallback to default image
            });

            // Display the "Chat" button
            const chatButton = document.getElementById('chat-button');
            chatButton.style.display = 'inline-block';
            chatButton.onclick = () => openCharacterPage(character.id, character.uploader);
        }

        // // Function to navigate to the chat page using URL parameters
        // function openCharacterPage(characterId, uploader) {
        //     // Construct the URL with characterId and uploader as parameters
        //     const chatUrl = `/chat.html?characterId=${encodeURIComponent(characterId)}&uploader=${encodeURIComponent(uploader)}`;

        //     // Redirect to the chat page with URL parameters
        //     window.location.href = chatUrl;
        // }

        // Function to retrieve URL parameters and set them in sessionStorage
        function setSessionStorageFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const characterId = params.get('characterId');
            const uploader = params.get('uploader');

            if (characterId) {
                sessionStorage.setItem('selectedCharacterId', characterId);
            }
            if (uploader) {
                sessionStorage.setItem('characterUploader', uploader);
            }
        }

        // Run the function on page load
        window.addEventListener('DOMContentLoaded', setSessionStorageFromUrl);


        // Function to navigate to the chat page
        function openCharacterPage(characterId, uploader) {
            // Use sessionStorage to save the character ID and uploader information
            sessionStorage.setItem('selectedCharacterId', characterId);
            sessionStorage.setItem('characterUploader', uploader);

            // Redirect to the chat page
            window.location.href = '/chat.html';
        }

        // Load character details on page load
        document.addEventListener('DOMContentLoaded', loadCharacterDetails);
    </script>      
</body>
</html>
